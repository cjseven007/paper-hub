<div class="flex h-full flex-col bg-white">
  <!-- Top bar -->
  <div class="flex items-center justify-between border-b border-zinc-200 px-4 py-3">
    <div class="flex items-center gap-2">
      <button
        type="button"
        (click)="onBackClick()"
        class="flex items-center gap-1 rounded-lg border border-zinc-200 px-3 py-1 text-xs font-medium text-zinc-700 hover:bg-zinc-50"
      >
        <!-- back arrow -->
        <svg viewBox="0 0 24 24" class="h-4 w-4">
          <path fill="currentColor" d="M15.5 5 9 11.5 15.5 18l1.5-1.5-5-5 5-5Z" />
        </svg>
        Back
      </button>

      <div class="ml-3">
        <div class="text-xs font-semibold uppercase tracking-wide text-zinc-500">My Workspace</div>
        <h1 class="text-lg font-semibold text-zinc-900">
          {{ paper()?.courseCode ?? 'Course Code' }}:
          {{ paper()?.courseName || (answerDoc()?.title ?? 'Course Name') }}
        </h1>
        @if (paper()?.examYear || paper()?.examDate) {
        <h2 class="text-sm text-zinc-500">
          <span class="font-semibold">Exam Date: </span>
          <span>{{
            (paper()?.examDate | date : 'dd MMM yyyy') || (paper()?.examYear ?? 'Date')
          }}</span>
        </h2>
        } @if (paper()?.universityName) {
        <h2 class="text-sm text-zinc-500">
          <span class="font-semibold">Univeristy: </span>
          <span>{{ paper()?.universityName ?? 'University' }}</span>
        </h2>
        }
      </div>
    </div>

    <div class="flex items-center gap-3">
      <span
        *ngIf="dirty()"
        class="rounded-full bg-amber-50 px-2 py-0.5 text-[10px] font-medium text-amber-700"
      >
        Unsaved changes
      </span>
      <button
        type="button"
        (click)="saveProgress()"
        [disabled]="saving() || !hasData"
        class="rounded-lg bg-zinc-900 px-4 py-2 text-xs font-medium text-white disabled:cursor-not-allowed disabled:opacity-60"
      >
        {{ saving() ? 'Saving…' : 'Save progress' }}
      </button>
    </div>
  </div>

  <!-- Body -->
  <div class="flex-1 p-4">
    @if (loading()) {
    <div class="flex h-full items-center justify-center text-sm text-zinc-500">
      Loading workspace item…
    </div>
    } @else if (!hasData) {
    <div class="flex h-full items-center justify-center text-sm text-red-500">
      {{ error() || 'Unable to load this item.' }}
    </div>
    } @else {
    <div class="flex h-full flex-col gap-3">
      <!-- Question tabs -->
      <div class="flex gap-2 overflow-x-auto border-b border-zinc-200 pb-2">
        @for (q of paper()!.questions; let i = $index; track q.question_number) {
        <button
          type="button"
          (click)="selectQuestion(i)"
          class="whitespace-nowrap rounded-full px-3 py-1 text-xs font-medium transition"
          [class.bg-zinc-900]="selectedQuestionIndex() === i"
          [class.text-white]="selectedQuestionIndex() === i"
          [class.text-zinc-600]="selectedQuestionIndex() !== i"
          [class.bg-zinc-100]="selectedQuestionIndex() !== i"
        >
          Q{{ q.question_number }}
        </button>
        }
      </div>

      <!-- Active question -->
      <div
        class="flex-1 min-h-0 md:mb-0 mb-15 overflow-y-auto rounded-xl border border-zinc-200 bg-white p-4"
      >
        @for (q of paper()!.questions; let i = $index; track q.question_number) { @if
        (selectedQuestionIndex() === i) {
        <div class="space-y-4">
          <!-- Question text -->
          <div>
            <div class="mb-1 flex items-center justify-between text-xs text-zinc-500">
              <span class="font-semibold">Question {{ q.question_number }}</span>
              @if (q.marks !== undefined && q.marks !== null) {
              <span>{{ q.marks }} marks</span>
              }
            </div>
            <p class="mb-2 whitespace-pre-line text-sm text-zinc-800">
              {{ q.text }}
            </p>
            <!-- Answer box for whole question -->
            <label class="mb-1 block text-xs font-medium text-zinc-700">
              Your answer (overall)
            </label>
            <textarea
              class="w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm outline-none focus:border-zinc-900 focus:ring-1 focus:ring-zinc-900"
              rows="4"
              [ngModel]="answerQuestions[i]?.answer"
              (ngModelChange)="updateQuestionAnswer(i, $event)"
            ></textarea>
          </div>

          <!-- Sub-questions -->
          @if (q.sub_questions?.length) {
          <div class="space-y-4 border-t border-zinc-100 pt-3">
            @for (sq of q.sub_questions; let j = $index; track sq.sub_number) {
            <div class="rounded-lg bg-zinc-50 p-3">
              <div class="mb-1 flex items-center justify-between text-xs text-zinc-500">
                <span class="font-semibold">Sub-question {{ sq.sub_number }}</span>
                @if (sq.marks !== undefined && sq.marks !== null) {
                <span>{{ sq.marks }} marks</span>
                }
              </div>
              <p class="mb-2 whitespace-pre-line text-xs text-zinc-800">
                {{ sq.text }}
              </p>

              <label class="mb-1 block text-[11px] font-medium text-zinc-700"> Your answer </label>
              <textarea
                class="w-full rounded-lg border border-zinc-200 px-3 py-2 text-sm outline-none focus:border-zinc-900 focus:ring-1 focus:ring-zinc-900"
                rows="3"
                [ngModel]="answerQuestions[i].sub_questions[j]?.answer"
                (ngModelChange)="updateSubAnswer(i, j, $event)"
              ></textarea>
            </div>
            }
          </div>
          }
        </div>
        } }
      </div>

      @if (error()) {
      <p class="text-sm text-red-500">{{ error() }}</p>
      }
    </div>
    }
  </div>

  @if (showBackConfirmDialog()) {
  <div class="fixed inset-0 z-40 flex items-center justify-center bg-black/30 backdrop-blur-sm">
    <div class="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
      <div class="mb-3 flex items-start justify-between gap-3">
        <div>
          <h3 class="text-sm font-semibold text-zinc-900">Unsaved changes</h3>
          <p class="mt-1 text-xs text-zinc-600">
            You have unsaved answers. Do you want to save them before going back to your workspace?
          </p>
        </div>
        <button
          type="button"
          (click)="closeBackConfirmDialog()"
          class="flex h-7 w-7 items-center justify-center rounded-full border border-zinc-200 text-zinc-500 hover:bg-zinc-50"
        >
          <svg viewBox="0 0 24 24" class="h-3.5 w-3.5">
            <path
              fill="currentColor"
              d="M18.3 5.7 12 12l6.3 6.3-1.4 1.4L10.6 13.4 4.3 19.7 2.9 18.3 9.2 12 2.9 5.7 4.3 4.3 10.6 10.6 16.9 4.3z"
            />
          </svg>
        </button>
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button
          type="button"
          (click)="confirmBack(false)"
          class="rounded-lg border border-zinc-200 px-3 py-1.5 text-xs font-medium text-zinc-700 hover:bg-zinc-50"
        >
          Go back without saving
        </button>
        <button
          type="button"
          (click)="confirmBack(true)"
          class="rounded-lg bg-zinc-900 px-4 py-1.5 text-xs font-medium text-white hover:bg-zinc-800"
        >
          Save &amp; go back
        </button>
      </div>
    </div>
  </div>
  }
</div>
